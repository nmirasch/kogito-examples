<!--
  ~ Copyright 2021 Red Hat, Inc. and/or its affiliates.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~       http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Kogito Publishing Example</title>

    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
</head>
<body>
<div class="container" role="main">
    <div class="jumbotron">
        <h1>Kogito Publishing Example</h1>

        <p>Create your own articles and see them published in our web easily!</p>
    </div>
    <div class="page-header">
        <div class="btn-group pull-right" role="group" style="padding-top: 10px;">
            <button class="btn btn-primary" onclick="load();">
                <span class="glyphicon glyphicon-refresh"></span> Refresh
            </button>
            <button class="btn btn-primary product-add" data-action="add" data-toggle="modal"
                    data-target="#productModal">
                <span class="glyphicon glyphicon-plus"></span> Add a new Article
            </button>
        </div>
        <h1>Articles</h1>
    </div>
    <div class="row">
        <div class="col-md-12">

            <table class="table">
                <thead>
                <tr>
                    <th>Id</th>
                    <th>Title</th>
                    <th>Author</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="content">
                <!-- filled using Ajax -->
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>
<script>
    const graphql = '{config:property('kogito.dataindex.http.url') or 'http://localhost:8180'}/graphql';

        $(function () {
            $.ajaxSetup({
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            $(function () {
                $("#tripBegin").datepicker({
                    dateFormat: "yy-mm-dd"
                });
                $("#tripEnd").datepicker({
                    dateFormat: "yy-mm-dd"
                });
            });
            load();
            initModal();

            if ("WebSocket" in window) {

                // Let us open a web socket
                var ws = new WebSocket('{config:property('kogito.dataindex.ws.url') or 'ws://localhost:8180'}/graphql');

                    ws.onopen = function () {

                        // Web Socket is connected, send data using send()
                        ws.send('{"id" : "2", "type" : "start", "payload" : { "query" : "subscription { PublishingUpdated { id, article { title, subtitle, content,discarded, onReview, published } author { userName, firstName, lastName, email  } metadata { processInstances { businessKey, state } } } }"}}');

                    };

                ws.onmessage = function (evt) {
                    var received_msg = evt.data;
                    let jsonObject = JSON.parse(received_msg);
                    var val = jsonObject.payload.data.TravelsUpdated;

                    var existing = document.getElementById(val.id);
                    if (existing != null) {
                        existing.remove();
                    }

                    appendDataRow(null, val);
                };

                ws.onclose = function () {

                    // websocket is closed.
                };
            }
        });

    function create(publishRequest) {
        var key = makeid();
        $.post("/publishing?businessKey=" + key, publishRequest, function () {
            load();
        }, "json");
    }

    function makeid() {
        var result = '';
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        var charactersLength = characters.length;
        for (var i = 0; i < 6; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    function remove(id) {
        $.ajax({
            method: "DELETE",
            url: "/publishing/" + id
        }).done(function () {

        });
    }


    function completeTask(id, taskName, taskId) {
        $.post("/publishing/" + id + "/" + taskName + "/" + taskId, JSON.stringify({}), function () {
        }, "json");
    }

    function load() {
        $("#content").children().remove();
        var query = "{ \"query\": \"" +
            "{ Publishing { " +
            "article { title, subtitle, content, status} " +
            "author { userName, firstName, lastName, email } " +
            "metadata { processInstances { state, businessKey } } " +
            "}}\"" +
            "}";
        $.ajax({
            type: 'POST',
            url: graphql,
            data: query,
            success: function (data) {
                $.each(data.data["Publishing"], function (key, val) {
                    appendDataRow(key, val);
                });
                initCallbacks();
            }
        });
    }

    function appendDataRow(key, val) {
        var active = $.grep(val.metadata.processInstances, function (pi) {
            return pi.state == "ACTIVE"
        }).length > 0;
        var html =
            "<tr id='" + val.id + "' class='" + (active ? "" : "active") + "'>" +
            "<td>" + val.metadata.processInstances[0].businessKey + "</td>" +
            "<td>" + val.article.title + ", " + val.article.subtitle + "</td>" +
            "<td>" + val.author.userName + "</td>" +
            "<td>" + val.status + "</td>" +
            "<td>" +
            "<button class='btn btn-primary btn-sm' " +
            "data-toggle='modal' " +
            "data-target='#detailsModal' " +
            "data-firstname='" + val.author.firstName + "' " +
            "data-lastname='" + val.author.lastName + "' " +
            "data-email='" + val.author.email + "' " +
            "data-userName='" + val.author.userName + "' " +
            "data-title='" + val.article.title + "' " +
            "data-subtitle='" + val.article.subtitle + "' " +
            "data-content='" + val.article.content + "' " +
            "data-status='" + val.article.status + "' " +
            "data-id='" + val.id + "'>" +
            "   <span>Details</span>" +
            "</button>&nbsp;";
        if (active) {
            html +=
                "<button class='btn btn-primary btn-sm' " +
                "data-toggle='modal' " +
                "data-target='#tasksModal' " +
                "data-firstname='" + val.article.title + "' " +
                "data-lastname='" + val.author.userName + "' " +
                "data-id='" + val.id + "'>" +
                "   <span>Tasks</span>" +
                "</button>&nbsp;" +
                "<button class='btn btn-danger btn-sm product-delete' data-id='" + val.id + "'>" +
                "   <span>Cancel</span>" +
                "</button>";
        }
        html += "</td></tr>";
        $(html).appendTo("#content");
    }

    function initCallbacks() {
        $(".product-delete").unbind().click(function () {
            var id = $(this).data("id");
            remove(id);
        });

    }

    function initModal() {
        $("#productModal").on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var action = button.data('action');
            var id = button.data('id');
            var productAction = $("#productAction");
            productAction.unbind();
            var modal = $(this);
            modal.find('.modal-title').text("Create a new Article");
            modal.find('#firstName').val("");
            modal.find('#lastName').val("");
            modal.find('#email').val("");
            modal.find('#userName').val("");

            modal.find('#title').val("");
            modal.find('#subtitle').val("");
            modal.find('#content').val("");
            modal.find('#status').val("");

            productAction.click(function () {

                var article = {
                    title: $("#title").val(),
                    subtitle: $("#subtitle").val(),
                    content: $("#content").val(),
                    status: $("#status").val()
                };
                var author = {
                    firstName: $("#firstName").val(),
                    lastName: $("#lastName").val(),
                    email: $("#email").val(),
                    userName: $("#userName").val(),
                };

                var publishRequest = JSON.stringify(\{ article: article, author : author\}) ;

                create(publishRequest);
                $('#productModal').modal('toggle');
            });

        })

        $("#detailsModal").on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var action = button.data('action');
            var id = button.data('id');
            var modal = $(this);
            modal.find('.modal-title').text("Details of travel for " + button.data("lastname") + ", " + button.data("firstname"));
            modal.find('#firstName').val(button.data("firstname"));
            modal.find('#lastName').val(button.data("lastname"));
            modal.find('#email').val(button.data("email"));
            modal.find('#nationality').val(button.data("nationality"));

            modal.find('#destinationCountry').val(button.data("country"));
            modal.find('#destinationCity').val(button.data("city"));
            modal.find('#tripBegin').val(button.data("begin"));
            modal.find('#tripEnd').val(button.data("end"));

            modal.find('#hotelname').val(button.data("hotelname"));
            modal.find('#bookingNumber').val(button.data("bookingnumber"));
            modal.find('#address').val(button.data("address"));
            modal.find('#phone').val(button.data("phone"));

            modal.find('#flightNumber').val(button.data("flightnumber"));
            modal.find('#departure').val(button.data("departure"));
            modal.find('#arrival').val(button.data("arrival"));
        })

        $("#tasksModal").on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var action = button.data('action');
            var id = button.data('id');
            var modal = $(this);
            modal.find('.modal-title').text("Tasks for " + button.data("lastname") + ", " + button.data("firstname"));

            $("#taskscontent").children().remove();
            $.getJSON("/travels/" + id + "/tasks", function (data) {
                $.each(data, function (key, val) {
                    if ("VisaApplication" == val.name) {
                        $("<tr><td>" + val.name + "</td>" +
                            "<td>" +
                            "<button class='btn btn-primary btn-sm' " +
                            "data-dismiss=\"modal\" " +
                            "data-toggle='modal' " +
                            "data-target='#visaApplicationModal' " +
                            "data-id='" + id + "' " +
                            "data-taskid='" + val.id + "'>" +
                            "   <span>Apply</span>" +
                            "</button>" +
                            "</td>" +
                            "</tr>").appendTo("#taskscontent");
                    } else {
                        $("<tr><td>" + val.name + "</td>" +
                            "<td>" +
                            "<button class='btn btn-primary btn-sm' onclick=\"completeTask('" + id + "', '" + val.name + "', '" + val.id + "')\" data-dismiss=\"modal\" " +
                            "   <span>Complete</span>" +
                            "</button>" +
                            "</td>" +
                            "</tr>").appendTo("#taskscontent");
                    }
                });

            })

            $("#visaApplicationModal").on('show.bs.modal', function (event) {
                var button = $(event.relatedTarget);

                var id = button.data('id');
                var taskid = button.data('taskid');
                var modal = $(this);
                modal.find('.modal-title').text("Visa application");

                $.getJSON("/travels/" + id + "/VisaApplication/" + taskid, function (data) {

                    $("#visa_firstName").val(data.traveller.firstName);
                    $("#visa_lastName").val(data.traveller.lastName);
                    $("#visa_email").val(data.traveller.email);
                    $("#visa_nationality").val(data.traveller.nationality);

                    $("#visa_destinationCity").val(data.trip.city);
                    $("#visa_destinationCountry").val(data.trip.country);
                    $("#visa_tripBegin").val(data.trip.begin);
                    $("#visa_tripEnd").val(data.trip.end);

                    $("#visa_p_id").val(id);
                    $("#visa_t_id").val(taskid);

                    $("#visa_passportNumber").val('');
                    $("#visa_duration").val('');
                });

            })
        })
    }
</script>
<div class="modal fade" id="productModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title" id="productModalTitle">Create a new Article</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">
                        <h3>Author</h3>
                        <div class="col-md-6 col-sm-6 col-xs-6">
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" required>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6 col-xs-6">
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="text" class="form-control" id="email" name="email" required>
                            </div>
                            <div class="form-group">
                                <label for="email">userName</label>
                                <input type="text" class="form-control" id="userName" name="userName" required>
                            </div>
                        </div>
                        <h3>Article</h3>
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="form-group">
                                <label>Title</label> <input type="text"
                                                            class="form-control" id="title" name="title" required>
                            </div>
                            <div class="form-group">
                                <label>Subtitle</label> <input type="text"
                                                               class="form-control" id="subtitle" name="subtitle" required>
                            </div>
                            <div class="form-group">
                                <label>Content</label>
                                <textarea class="form-control" id="content" name="content" required></textarea>
                            </div>
                            <div class="form-group">
                                <label>Status</label> <input type="text"
                                                             class="form-control" id="status" name="status" required>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default"
                                    data-dismiss="modal">Cancel
                            </button>
                            <button type="button" id="productAction" class="btn btn-primary">Create new article</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title" id="detailsModalTitle">Details of an Article</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">

                        <div class="col-md-6 col-sm-6 col-xs-6">
                            <div class="form-group">
                                <h3>Author</h3>
                            </div>
                            <div class="form-group">
                                <label for="firstName">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" readonly>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name</label>
                                <input type="text" class="form-control" id="lastName" name="lastName" readonly>
                            </div>
                            <div class="form-group">
                                <label for="email">Email</label>
                                <input type="text" class="form-control" id="email" name="email" readonly>
                            </div>
                            <div class="form-group">
                                <label for="email">userName</label>
                                <input type="text" class="form-control" id="userName" name="userName" readonly>
                            </div>
                        </div>

                        <div class="col-md-6 col-sm-6 col-xs-6">
                            <div class="form-group">
                                <h3>Article</h3>
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" class="form-control" id="title" name="title" readonly>
                            </div>
                            <div class="form-group">
                                <label>Subtitle</label>
                                <input type="text" class="form-control" id="subtitle" name="subtitle" readonly>
                            </div>
                            <div class="form-group">
                                <label>Content</label>
                                 <textarea class="form-control" id="content" name="content" readonly></textarea>
                            </div>
                            <div class="form-group">
                                <label>Status</label>
                                <input type="text"  class="form-control" id="status" name="status" readonly>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="tasksModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title" id="detailsModalTitle">Details of an article</h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">
                    <div class="row">

                        <div class="col-md-12">
                            <h1>Tasks</h1>
                            <table class="table table-striped">
                                <thead>
                                <tr>
                                    <th>Task name</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="taskscontent">
                                <!-- filled using Ajax -->
                                </tbody>
                            </table>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
</html>
